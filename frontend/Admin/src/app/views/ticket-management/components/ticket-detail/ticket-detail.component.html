<div class="offcanvas-header border-bottom">
  <div class="d-flex flex-column gap-2 w-100">
    <div class="d-flex gap-2 align-items-center w-100">
      <button 
        type="button" 
        class="btn btn-sm btn-light me-2" 
        (click)="closeDetail()" 
        aria-label="Geri"
        style="cursor: pointer; min-width: 40px;">
        <i class="mdi mdi-arrow-left fs-18"></i>
      </button>
      <h5 class="offcanvas-title text-truncate flex-grow-1 mb-0 fw-bold">{{ ticket?.title }}</h5>
    </div>
    <div class="d-flex align-items-center justify-content-between gap-2 ms-5">
      <div class="d-flex align-items-center gap-2">
        <span *ngIf="ticket?.tenantName || ticket?.tenantId" class="badge bg-primary text-white">
          <i class="mdi mdi-office-building me-1"></i>{{ ticket?.tenantName || ('Firma ' + ticket?.tenantId) }}
        </span>
        <span class="badge {{ getPriorityColor(ticket?.priority || 'Medium') }}">{{ ticket?.priority }}</span>
        <span class="badge {{ getStatusColor(ticket?.status || 'Open') }}">{{ ticket?.status }}</span>
        <small class="text-muted">
          <i class="mdi mdi-calendar me-1"></i>
          <span *ngIf="ticket && ticket.createdDate">{{ ticket.createdDate | date:'dd.MM.yyyy HH:mm' }}</span>
        </small>
      </div>
      <div *ngIf="isSuperAdmin">
        <div class="btn-group" role="group">
          <button 
            type="button" 
            class="btn btn-sm btn-success" 
            (click)="updateTicketStatus('Resolved')"
            [disabled]="updatingStatus || ticket?.status === 'Resolved'"
            [ngbTooltip]="ticket?.status === 'Resolved' ? 'Zaten çözüldü' : 'Çözüldü olarak işaretle'">
            <i class="mdi mdi-check-circle me-1"></i>Çözüldü
          </button>
          <button 
            type="button" 
            class="btn btn-sm btn-secondary" 
            (click)="updateTicketStatus('Closed')"
            [disabled]="updatingStatus || ticket?.status === 'Closed'"
            [ngbTooltip]="ticket?.status === 'Closed' ? 'Zaten kapatıldı' : 'Kapat'">
            <i class="mdi mdi-archive me-1"></i>Kapat
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="offcanvas-body p-0" style="display: flex; flex-direction: column; height: calc(100vh - 200px); overflow: hidden;">
  <!-- İçerik Alanı - Scroll Edilebilir -->
  <div style="flex: 1 1 auto; overflow-y: auto; overflow-x: hidden; min-height: 0;">
    <div class="p-4">
      <!-- Açıklama Bölümü -->
      <div class="mb-4">
        <h6 class="mb-3 fw-bold text-dark">
          <i class="mdi mdi-text me-2"></i>Açıklama
        </h6>
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <p class="mb-0 text-dark" style="white-space: pre-wrap; line-height: 1.8; font-size: 14px;">
              {{ ticket?.description || 'Açıklama bulunmuyor.' }}
            </p>
          </div>
        </div>
      </div>

      <!-- Ekler Bölümü -->
      <div *ngIf="ticket && ticket.attachments && ticket.attachments.length > 0" class="mb-4">
        <hr class="my-4" />
        <h6 class="mb-3 fw-bold text-dark">
          <i class="mdi mdi-paperclip me-2"></i>Ekler <span class="badge bg-secondary">{{ ticket.attachments.length }}</span>
        </h6>
        <div class="d-flex flex-wrap gap-3">
          <div *ngFor="let attachment of ticket.attachments" class="mb-2">
            <a href="#" (click)="downloadAttachment(attachment); $event.preventDefault()" class="text-decoration-none">
              <div *ngIf="attachment.fileType && attachment.fileType.startsWith('image/')" class="border rounded p-2">
                <img [src]="getAttachmentUrl(attachment)" alt="attachment" style="height: 100px; width: auto;" class="img-thumbnail" />
              </div>
              <div *ngIf="!attachment.fileType || !attachment.fileType.startsWith('image/')" class="border rounded p-3 text-center" style="min-width: 120px;">
                <i class="mdi mdi-file-outline fs-2 text-primary d-block mb-2"></i>
                <div class="small text-dark text-truncate" style="max-width: 120px;">{{ attachment.fileName }}</div>
              </div>
            </a>
          </div>
        </div>
      </div>

      <!-- Yorumlar Bölümü -->
      <div class="mb-4">
        <hr class="my-4" />
        <h6 class="mb-3 fw-bold text-dark">
          <i class="mdi mdi-comment-outline me-2"></i>Yorumlar 
          <span class="badge bg-primary">{{ ticket?.comments?.length || 0 }}</span>
        </h6>
        
        <div *ngIf="ticket && ticket.comments && ticket.comments.length > 0" class="mb-3">
          <div *ngFor="let comment of ticket.comments" class="card mb-3 border shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="d-flex align-items-center">
                  <i class="mdi mdi-account-circle text-primary me-2 fs-5"></i>
                  <strong class="text-dark">{{ comment.userName || 'Kullanıcı' }}</strong>
                </div>
                <small class="text-muted">
                  <i class="mdi mdi-clock-outline me-1"></i>
                  <span *ngIf="comment.createdDate">{{ comment.createdDate | date:'dd.MM.yyyy HH:mm' }}</span>
                </small>
              </div>
              <p class="mb-0 text-dark" style="white-space: pre-wrap; line-height: 1.8; font-size: 14px;">
                {{ comment.comment }}
              </p>
              <div *ngIf="comment.attachments && comment.attachments.length > 0" class="mt-3 pt-3 border-top">
                <small class="text-muted d-block mb-2 fw-bold">Ekler:</small>
                <div class="d-flex flex-wrap gap-2">
                  <a *ngFor="let att of comment.attachments" 
                     href="#" 
                     class="badge bg-secondary text-white text-decoration-none p-2" 
                     (click)="downloadAttachment(att); $event.preventDefault()">
                    <i class="mdi mdi-file-outline me-1"></i>{{ att.fileName }}
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div *ngIf="!ticket || !ticket.comments || ticket.comments.length === 0" class="text-center py-4">
          <i class="mdi mdi-comment-remove-outline fs-1 text-muted"></i>
          <p class="text-muted mt-2 mb-0">Henüz yorum yapılmamış.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Yorum Yazma Alanı - Sabit Alt Kısım -->
  <div class="border-top bg-white p-3" style="flex: 0 0 auto;">
    <div class="mb-2">
      <textarea 
        class="form-control" 
        rows="3" 
        [(ngModel)]="commentText" 
        placeholder="Yorumunuzu yazın..."
        [disabled]="saving"
        style="resize: vertical;"></textarea>
    </div>
    <div class="mb-2" *ngIf="commentFiles.length > 0">
      <div *ngFor="let file of commentFiles; let i = index" class="d-flex justify-content-between align-items-center mb-1 p-2 bg-light rounded">
        <span class="small"><i class="mdi mdi-file-outline me-1"></i>{{ file.name }} ({{ formatFileSize(file.size) }})</span>
        <button type="button" class="btn btn-sm btn-link text-danger p-0" (click)="removeCommentFile(i)">
          <i class="mdi mdi-close"></i>
        </button>
      </div>
    </div>
    <div class="mb-2">
      <input type="file" multiple accept="image/*,.pdf" (change)="onCommentFileSelected($event)" class="form-control form-control-sm">
      <small class="text-muted">Dosya eklemek için seçin (opsiyonel)</small>
    </div>
    <div class="text-end">
      <button type="button" class="btn btn-primary btn-sm" (click)="addComment()" [disabled]="!commentText.trim() || saving">
        <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
        <i class="mdi mdi-send me-1"></i>Gönder
      </button>
    </div>
  </div>
</div>
